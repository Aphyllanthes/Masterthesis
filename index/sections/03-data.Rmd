
```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
options(scipen=999)
```


# Ergebnisse
In den Nisthilfen des Schulinsektenhaus-Projektes welche im Jahr 2019 ausgehängt waren wurden 4716 Bienennester sowie 2147 Wespennester aufgefunden. Somit machen die in dieser Arbeit behandelten Nester etwa 70 % der vorgefundenen Nester aus. Die Wespennester werden in dieser Arbeit nicht behandelt.
Alle weiteren Ergebnisse beziehen sich ausschließlich auf die Biennennester. In Abbildung \ref{deskriptiv} sind die Histogramme der Artenanzahl und Abundanz dargestellt.

```{r message=FALSE, warning=FALSE, include=FALSE, cache=TRUE}
#source("datenschau.R")
load("../my_work_space.RData")
```


<!-- Anzahl der Arten pro Nisthilfe | -->
<!-- Anzahl Brutzellen pro Nisthilfe | -->
<!-- | Überlebensrate | Anzahl der lebenden Puppen dividiert durch die Gesamtanzahl der Zellen | -->
<!-- | Parasitierungsrate | Anzahl der parasitierten Zellen dividiert durch die Gesamtanzahl der Zellen | -->

```{r datendeskriptiv, echo=FALSE, fig.cap="Histogramme der Anzahl der Wirts-Bienenarten pro Nisthilfe (links) und Anzahl der von Bienen angelegten Brutzellen (=Abundanz) pro Nisthilfe (rechts) \\label{deskriptiv}"}
p1 <- ggplot(A1, aes(Artenanzahl_det)) + geom_histogram(bins = 8) +
  theme_bw() + labs(x = "Artenzahl der Wirte")
p2 <- ggplot(A1, aes(Abundanz)) + geom_histogram(breaks=c(seq(0, 14, by = 1),seq(15, 100, by = 5), seq(110, 240, by = 10), seq(250, 850, by = 20))) + theme_bw() 

gridExtra::grid.arrange(p1, p2, ncol = 2, heights = unit(4, c("in")))

# sum(nests$nb_cells, na.rm = T) # Anzahl der Zellen gesamt: 18757
# sum(nests$nb_pupa_larva, na.rm = T) # Anzahl Puppen/Larven: 11376
# sum(nests$nb_pupa_larva, na.rm = T) / sum(nests$nb_cells, na.rm = T)
# sum(nests$parasitized_cells, na.rm = T) # Anzahl Parasitierter Zellen
# sum(nests$parasitized_cells, na.rm = T) / sum(nests$nb_cells, na.rm = T)
```


Von den insgesamt `r round(sum(nests$nb_cells, na.rm = T),0)` angelegten Zellen entwickelten sich in etwa 60 % (`r round(sum(nests$nb_pupa_larva, na.rm = T),0)` Brutzellen) Puppen bzw. Larven. Etwa 13 % der Angelegten Zellen wurde Parasitiert (`r sum(nests$parasitized_cells, na.rm = T)` Brutzellen).  

In 45 der 259 Nisthilfen kamen keine Bienen vor. Die häufigsten Wirtsbienenarten waren *Osmia bicornis*, welche 46 % der Nester belegten und *Heriades truncorum*, welche 16 % der Nester belegten. *Osmia cornuta* und *Hylaeus communis* belegten jeweils etwa 8 % der Nester, alle weiteren Arten belegten jeweils weniger als 5 % der Nester.
Der häufigste natürliche Gegenspieler war die Taufliege *Cacoxenus indagator*, welche 17 % aller Nester parasitierte. Arten der Überfamilie der Erzwespen (Chalcidoidea) parasitierten 150 Nester, also 3 % aller Nester, wobei vermutlich die Art *Melittobia acasta* den Großteil davon ausmachte. Die Kuckuckswespe *Sapygina decemguttata* kam mit einer Parasitierungsrate von knapp unter 3 % vor. Alle weiteren natürlichen Gegenspieler kamen je nur in weniger als 100 Nestern und somit in unter 2% aller Nester vor.

## Die Arten in den Nisthilfen
Im Rahmen des Schulinsektenhaus-Projektes konnten in den 259 Nisthilfen insgesammt 27 Wirts-Bienenarten sowie als Parasitoide fünf Kuckucksbienenarten (*Stelis* und *Coelioxys*) und neun Wespenarten (Apocrita) nachgewiesen werden. Weitere Gegenspieler wie verschiedene Diptera, Käfer (Coleoptera), Milben (*Chaetodacylus*) und Eulophidae kamen vor, wurden jedoch nicht genauer bestimmt. In Tabelle \ref{Artenliste} sind alle nachgewiesenen Arten sowie ihre Gegenspieler aufgeführt. Da einige Parasitoide das gesamte Nest ihres Wirtes eingenommen haben konnten die Wirtsarten nur anhand der Nestmorphologie bestimmt werden - diese sind in der dritten Spalte der Tabelle aufgeführt.

Im Vergleich zu @tscharntke1998 wurden sieben weitere Arten identifiziert: 

  - *Anthidium manicatum*
  - *Hylaeus graciliformis*, *H. hyalinatus*, *H. leptocephalus*, *H. taeniolatus*
  - *Megachile centuncularis*, *M. ligniseca* 
  
Dagegen führen @tscharntke1998 in ihrer Arbeit zwölf Arten auf, die in dieser Arbeit nicht identifiziert wurden:
 
 - *Chelostoma campanularum*, *C. distinctum*
 - *Hylaeus annularis*, *H. gibbus*, *H. punctualissimus*, *H. signatus*
 - *Megachile alpicola*, *M. versicolor*
 - *Osmia claviventris*, *O. gallarum*, *O. leucomelana*, *O. parietina*
 
Ein weiterer Parasit der in den Nestern dieser Arbeit vorkam, sind Milben der Gattung *Chaetodactylus*. Diese sind in der Tabelle \ref{Artenliste} nicht aufgeführt, da sie während der Lagerung in der Uni Freiburg in weitere Nester "übergelaufen" sind. Daher und durch zu späte Kenntnissnahme der bearbeitenden Personen wurden wahrscheinlich viele befallene Nester nicht als solche identifiziert. Es wurden ca. 100 Nester als von Chaetodactylus befallen identifiziert. Es kann aber davon ausgegangen werden, dass etwa das dreifache an Nestern befallen war. Leider konnten so aus sehr vielen Nestern keine Arten bestimmt werden - besonders groß war der Anteil an Nestern der Gattung *Megachile*. Identifiziert werden konnten dennoch folgende von Chaetodactylus befallene Arten:

  - *Anthidium nanum*
  - *Chelostoma florisomne*, *C. rapunculi* 
  - *Heriades crenulatus*, *H. truncorum* 
  - *Hylaeus communis*, *H. difformis*
  - *Megachile ericetorum*, *M. centuncularis*, *M. rotundata*
  - *Osmia adunca*, *O. bicornis*, *O. caerulescens*, *O. leaiana*
 
<!-- Welche Parasiten bei tscharntke vorkamen und bei uns nicht: Stelis punctulatissima bei Anthidium nanum, ... -->

 
```{r Artenliste, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
Artliste_IH19 <- readxl::read_excel("../../Daten/Artliste_IH19.xls") %>% 
  replace(is.na(.), "")

kableExtra::kbl(Artliste_IH19,longtable =T,booktabs =T, caption = "Liste aller nachgewiesenen Bienenarten und ihere Parasitoide im Schulinsektenhausprojekt 2019. Alle Arten die in der Arbeit von Tscharntke et al. (1998) nicht beschrieben wurden bzw. bei den Gegenspielern nicht bei dem entsprechenden Wirt beschrieben wurden, sind mit einem '*' versehen.  \\label{Artenliste} ") %>% 
  kableExtra::kable_paper(full_width = F) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header")) %>% 
  kableExtra::column_spec(1) %>%
  kableExtra::column_spec(2, width = "15em") %>%
  kableExtra::column_spec(3, width = "15em")
```



<!-- - chrysura radians an osmia adunca : zetero Galanthea (ohne id) -->

<!-- - ephialtes: @horstmann -->

## Der Einfluss der Landschaftstruktur 
Zwischen den Parametern der Landschaftstruktur, Kantenlänge und Anzahl der Landnutzungsklassen, und allen Modellierten Antwortvariablen konnte kein Zusammenhang aufgezeigt werden. 


<!-- Zwischen den Sturkturreichtum bescheibenden Parametern Kantendichte und Anzahl der Landnutzungsklassen und der Abundanz der Bienen kann kein Zusammenhang aufgezeigt werden. Ebenso wird kein Zusammenhang der den Strukturreichtum beschreibenden Parametern und der Artenzahl der Bienen beschrieben.  -->


## Der Einfluss von vorhandenen Insektenhäusern auf Artenzahl und Abundanz der Wildbienen
Das Modell, welches den Einfluss von vorhandenen Insektenhäusern auf die Artenzahl der Wildbienen beschreibt, zeigt einen schwach signifikanten Einfluss der Insektenhäuser auf. Die Artenzahl in den Nisthilfen in der Nähe eines Insektenhauses ist demnach höher als in Nisthilfen ohne Insektenhaus. Dieses Modell kann durch die Erweiterung um die Prädiktoren des mittleren Versiegelungsgrades als linearer sowie quadratischer Term nicht verbessert werden. Dies gilt für alle Radien für den der mittlere Versiegelungsgrad berechnet wurde. Umgekehrt verbessert der Parameter "Insektenhaus" das Modell mit den Prädiktoren "Versiegelungsgrad" und "Versiegelungsgrad im Quadrat" ebensowenig.  
In Tabelle \ref{summaryIH} ist der Einfluss den vorhandenen Insektenhäusern auf die Artenzahl in der linken Hälfte abgebildet. Es ist jeweils auch das um die Prädiktoren des Versiegelungsgrades im 250m-Radius erweiterte Modell abgebildet. Das um den Versiegelungsgrad im 250m-Radius erweiterte Modell der Artenzahl weist einen geringfügig höheren $R^2$-Wert auf, der Versiegelungsgrad sowie vorhandene Insektenhäuser haben keinen signifikanten Effekt. Der $R^2$-Wert beider Modelle  ist kleiner $0.1$, was bedeutet, dass die verwendeten Prädiktoren nur einen geringen Teil der Varianz der Artenzahl erklären.  

Der Einfluss von vorhandenen Insektenhäusern auf die Abundanz der Wildbienen zeigt weder im Modell mit den zusätzlichen Prädiktoren des mittleren Versiegelungsgrades im 250m-Radius als linearen und quadratischen Therm einen signifikanten Zusammenhang, noch im Modell ohne diesen Prädiktor (siehe Tab. \ref{summaryIH}). Die Erweiterung des Modells um den Versiegelungsgrad im 250m-Radius der einzige Radius des Versiegelungsgrades (aus den berechneten Radien von 100m,250m,500m,1000m,2000m), welcher das Modell der vorhandenen Insektenhäusern verbessert. Andersherum kann durch den Parameter "Insektenhaus" kein Modell mit dem Prädiktor Versiegelungsgrad verbessert werden.
Ein Effekt-Plot des um den Parameter des 250m-Versiegelungsgrades erweiterten Modells ist in Abbilung \ref{effektplotIH} auf der rechten Seite dargestellt. Das Modells zeigt einen negativen signifikanten linearen Zusammenhang zwischen dem mittleren Versiegelungsgrad im 250m-Radius und der Abundanz (siehe Tab. \ref{summaryIH}).

Für beide Variablen Artenzahl und Abundanz kann mit dem Datensatz von 129 Punkten nur eine Tendenz eines positiven Einflusses von vorhandenen Insektenhäusern beobachtet werden, wobei dieser Einfluss auf die Artenzahl deutlicher zu sehen ist als auf die Abundanz. 


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Einfluss von vorhandenem Insektenhaus auf Artenanzahl (links) und Abundanz (rechts) der Bienen. Die Fehlerbalken sind 'marginal effect-plots', welche die Vorhersage der Modelle (Mittelwert und Standartabweichung) bei variablem Versiegelungsgrad darstellen. Die Punkte sind die realen Datenpunkte. \\label{effektplotIH}" }
library(MASS)

sub_IH <- A1_IH_factor %>% 
  filter(!is.na(Insektenhaus)) %>% 
  mutate_at(vars(imp100:test3), scale)
## einfluss von Insektenhaus auf artenzahl:
modelIH <- glm.nb(Artenanzahl_det ~ Insektenhaus, data = sub_IH) ## signifikant

model_IH2a <- glm.nb(Artenanzahl_det ~ imp250 + I(imp250^2) + Insektenhaus, data = sub_IH) # signifikant

p1ep <- jtools::effect_plot(modelIH, pred = Insektenhaus, interval = TRUE, plot.points = TRUE,
                    jitter = .2) + 
  ylab("Artenzahl der Wirtsbienen")

## Abundanz:
model_IH5_zi <- readRDS("../Modelle/model_IH5_zi.rds")
model_IH2_250_zi <- readRDS("../Modelle/model_IH2_250_zi.rds")

# jtools::effect_plot(model_IH5_zi, pred = Insektenhaus, interval = TRUE, plot.points = TRUE,
#                     jitter = .2) +
#   ylab("Abundanz")

tranlabels <- function(x) attr(sub_IH$imp250, "scaled:center") + attr(sub_IH$imp250, "scaled:scale")*x
werte <- paste(round(tranlabels(c(-1, 0, 1)),2), collapse = ", ")

labeltext <- list("Die Werte des skalierten", 
                         "Versiegelunsgrades -1, 0, 1", 
                  "entsprechen den prozentualen", 
                         paste0("Werten von ", werte))

p2pm <- sjPlot::plot_model(model_IH2_250_zi, type = "pred", 
                   terms = c("Insektenhaus", "imp250"), 
                   show.p = T, show.data = T, jitter = T)+
  theme_bw() +
  annotate("text", y = seq(450,400,length=4), x = 0.35,
            label = labeltext)

gridExtra::grid.arrange(p1ep, p2pm, ncol = 2, heights = unit(4, c("in")))

```



```{r echo=FALSE}

detach("package:MASS")
#test <- sjPlot::tab_model(modelIH,  dv.labels = c("Artenzahl"), file = "modelIH.html", transform = NULL) 

tables <- rlist::list.clean(XML::readHTMLTable("../modelIH.html"), fun = is.null, recursive = FALSE)
tables2 <- tables[[1]] %>% 
  janitor::row_to_names(row_number = 1) %>% 
  as.matrix() %>% as_tibble()

#model_IH2a,
#test <- sjPlot::tab_model(model_IH2a,  dv.labels = c("Abundanz"), file = "model_IH2a.html", transform = NULL) 

tables3 <- rlist::list.clean(XML::readHTMLTable("../model_IH2a.html"), fun = is.null, recursive = FALSE)
tables4 <- tables3[[1]] %>% 
  janitor::row_to_names(row_number = 1) %>% 
  as.matrix() %>% as_tibble()

table_1 <- tables4 %>%  left_join(tables2, by = "Predictors", suffix = c("", " "))
table_1[is.na(table_1)] <- ""

## Abundanz: 

#test <- sjPlot::tab_model(model_IH5_zi,  dv.labels = c("Artenzahl"), file = "model_IH5_zi.html", transform = NULL) 

tables5 <- rlist::list.clean(XML::readHTMLTable("../model_IH5_zi.html"), fun = is.null, recursive = FALSE)
tables6 <- tables5[[1]] %>% 
  janitor::row_to_names(row_number = 1) %>% 
  as.matrix() %>% as_tibble() %>% 
  mutate(Predictors = janitor::make_clean_names(Predictors) )

#model_IH2a,
#test <- sjPlot::tab_model(model_IH2_250_zi,  dv.labels = c("Abundanz"), file = "model_IH2_250_zi.html", transform = NULL) 

tables7 <- rlist::list.clean(XML::readHTMLTable("../model_IH2_250_zi.html"), fun = is.null, recursive = FALSE)
tables8 <- tables7[[1]] %>% 
  janitor::row_to_names(row_number = 1) %>% 
  as.matrix() %>% as_tibble() %>% 
  mutate(Predictors = janitor::make_clean_names(Predictors) )
  

table_2 <- tables8 %>%  left_join(tables6, by = "Predictors", suffix = c("", " "))
table_2[is.na(table_2)] <- ""
table_2$Predictors <- c("count_model", "(Intercept)", "imp250", "imp250^2", "Insektenhaus [1]", "Intercept_2", "zero_inflated_model", "Intercept_3", "Observations")

##
# summary(model_IH5_zi)
# summary(model_IH2_250_zi) # laut anova: ist besser als model_IH5_zi 

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
#htmltools::includeHTML("test.html")
table_a <- table_1 %>% 
  full_join(table_2, by = "Predictors", suffix = c(".","..")) %>% 
  filter(!Predictors %in% c("zero_inflated_model", "count_model"))
table_a[is.na(table_a)] <- ""
table_a[table_a$Predictors == "Intercept_2",1] <- "count_model: Intercept"
table_a[table_a$Predictors == "Intercept_3",1] <- "zero_inflated_model: Intercept"

kableExtra::kbl(table_a, booktabs =T, caption = "Modellzusammenfassung der Modellvariablen Artenzahl und Abundanz. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung der Antwortvariablen an den reduzierten Datensatz aller Nisthilfen mit Information zum vorhandensein eines Insektenhauses gefittet.  \\label{summaryIH} " ) %>% #caption = "" 
  kable_styling(latex_options =c("striped", "hold_position")) %>% 
  kableExtra::add_header_above(c(" ","Artenzahl"=6,"Abundanz"=6)) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down")) %>% 
  kableExtra::column_spec(4,bold = (as.numeric(table_a$p.)<0.05 | table_a$p. == "<0.001")  & table_a$p. != "" )%>% 
  kableExtra::column_spec(7,bold = (as.numeric(table_a$`p .`)<0.05 | table_a$`p .` == "<0.001") & table_a$`p .` != "") %>% 
  kableExtra::column_spec(10,bold = (as.numeric(table_a$p..)<0.05 | table_a$p.. == "<0.001") & table_a$p.. != "") %>% 
  kableExtra::column_spec(13,bold = (as.numeric(table_a$`p ..`)<0.05 | table_a$`p ..` == "<0.001") & table_a$`p ..` != "") 

```



## Der Einfluss des Versiegelungsgrades auf Artenzahl und Abundanz der Bienen
  

<!-- Anhand AIC und Residuendiagnostik wurden für beide Variablen, Artenzahl sowie Abundanz, negativ-binomiale GLM mit folgender Formel ausgewählt: $y = imp1000 + imp1000^2 + Insektenhaus$ (imp1000 ist der mittlere Versiegelungsgrad im 1000m Radius um den Nisthilfenstandort) -->
<!-- Die Datenpunkte sowie die Modellvorhersage als marginaler Effektplot sind in Abbildung \ref{effektplotIH} dargestellt. Das Modell der Artenzahl beschreibt einen signifikanten Einfluss des Parameters Insektenhaus (siehe Tab. \ref{summaryIH}). Im Modell der Abundanz ist eine Tendenz einer Zunahme der Abundanz bei Vorhandensein eines Insektenhauses zu erkennen, welche jedoch nicht signifikant ist. In beiden Modellen hat der Versiegelungsgrad im 1000m Umkreis keinen signifikanten Einfluss. -->
 

<!-- (Null_deviance - Residual_deviance)/Null_deviance -->




Zur Analyse des Einflusses des Versiegelungsgrades verschiedener Radien auf die Artenzahl wurde für jeden Radius das beste Modell anhand von AIC, anova und Residuendiagnostik ausgewählt. Die Modellzusammenfassung ist in Tabelle \ref{summary_Artenzahl} dargestellt. Die Modellformeln sind im folgenden aufgeführt, wobei "imp_r" den Versiegelungsgrad im Radius r beschreibt, "annual_precipitation_mm" den Jahresniederschlag in mm, "mean_annual_temp_celsius" die mittlere Jahrestemperatur in grad Celsius und "altitude_town_m" die Höhenlage über NN:

\begin{align}
Artenanzahl \sim imp_{100} + Jahresmitteltemp.\_celsius + Jahresniederschlag\_mm + Höhenlage\_m \label{Az_1} \\
Artenanzahl \sim imp_{250} + Jahresmitteltemp.\_celsius + Jahresniederschlag\_mm \label{Az_2} \\
 Artenanzahl \sim imp_{500} + Jahresmitteltemp.\_celsius + Jahresniederschlag\_mm \label{Az_3} \\
 Artenanzahl \sim imp_{1000}^2 \label{Az_4} \\
Artenanzahl \sim imp_{2000}^2 \label{Az_5}
\end{align}

Modelle mit dem Prädiktor der Radien 100m, 250m und 500m des Versigelungsgrades können durch das Erweitern der Prädiktoren um die Klimavariablen "mittlere Jahrestemperatur" sowie "Jahresniederschlag" verbessert werden. Im 100m-Radius verbessert zusätzlich die Höhenlage des Nisthilfenstandortes das Modell. In den Modellen mit den Radien des Versiegelungsgrades von 1000m und 2000m beschreibt der quadratische Term des Versiegelungsgrades als einzelner Prädiktor die Artenzahl der Wildbienen am besten. Der $R^2$-Wert all dieser Modelle liegt unter dem Wert von $0.1$, somit erklären all diese Modelle die Varianz der Daten nur minimal.

Der Versiegelungsgrad der kleineren Radien von 100m, 250m und 500m beschreibt den Versiegelungsgrad im Bereich des Flugradius der Bienen, weshalb diese Parameter zur Beschreibung den Einfluss von direkt verfügbaren Ressourcen für die Bienen dienen. Der Versiegelungsgrad der größeren Radien von 1000m und 2000m stellt dagegen einen Indikator für den Grad der Urbanisierung und den Grad der Habitatvernetzung dar.

Der Versiegelungsgrad hat im 100m, 250m und 500m-Radius einen negativen signifikanten linearen Einfluss auf die Artenzahl der Bienen. Mit zunehmender Versiegelung nimmt die Artenzahl ab.
Zusätzlich beschreibt die Höhenlage des Nisthilfenstandortes im Modell mit dem Versiegelungsgrad im 100m-Radius einen postitiven signifikanten Zusammenhang. Der mittlere Versiegelungsgrad im 1000m und 2000m-Radius hat einen signifikanten quadratischen Einfluss auf die Artenzahl der Wildbienen. Bei einem Versiegelungsgrad von ca. $30 \%$ ist die Artenzahl maximal (Abbildung \ref{plot_modelle_artenzahl} rechts). 


 


```{r impsubs, include=FALSE}
## imp100:

A1_100 <- A1 %>% 
  dplyr::select(-imp250, -imp500, -imp1000, -imp2000) %>% 
  dplyr::select(-DistInsektenhaus, -Isnsektenhaus)

names(A1_100)[4] <- "imp"
A1_100 <- A1_100 %>% 
  dplyr::select(-Urban) %>% 
  mutate_at(vars(imp:test3), scale)

## imp250:
A1_250 <- A1 %>% 
  dplyr::select(-imp100, -imp500, -imp1000, -imp2000) %>% 
  dplyr::select(-DistInsektenhaus, -Isnsektenhaus)

A1_250 <- A1_250 %>% 
  dplyr::select(-Urban)%>% 
  rename(imp = imp250) %>% 
  mutate_at(vars(imp:test3), scale)

## imp500:
A1_500 <- A1 %>% 
  dplyr::select(-imp100, -imp250, -imp1000, -imp2000) %>% 
  dplyr::select(-DistInsektenhaus, -Isnsektenhaus)
names(A1_500)[4] <- "imp"
A1_500 <- A1_500 %>% 
  dplyr::select(-Urban, -len)%>% 
  mutate_at(vars(imp:test3), scale)

## imp1000:
A1_1000 <- A1 %>% 
  dplyr::select(-imp100, -imp250, -imp500, -imp2000) %>% 
  dplyr::select(-DistInsektenhaus, -Isnsektenhaus)
names(A1_1000)[4] <- "imp"
A1_1000 <- A1_1000 %>% 
  dplyr::select(-Urban, -len)%>% 
  mutate_at(vars(imp:test3), scale)

## imp2000:
A1_2000 <- A1 %>% 
  dplyr::select(-imp100, -imp250, -imp500, -imp1000) %>% 
  dplyr::select(-DistInsektenhaus, -Isnsektenhaus)
names(A1_2000)[4] <- "imp"
A1_2000 <- A1_2000 %>% 
  dplyr::select(-Urban)%>% 
  mutate_at(vars(imp:test3), scale)
```


<!-- Zwischen der Artenzahl und dem Versiegelungsgrad besteht kein signifikanter Zusammenhang.   -->
<!-- Zwischen Abundanz und dem mittleren Versiegelungsgrad im 1000m-Radius besteht ein signifikanter quadratischer Zusammenhang. Für den mittleren Versiegelungsgrad geringerer Radien besteht kein Zusammenhang. -->

```{r Artenzahl, include=FALSE}
## selected models::
# model0 <- MASS::glm.nb(Artenanzahl_det ~ . + I(imp^2), data = A1_100[,-c(1,3)]) ##
# model0_step <- MASS::stepAIC(model0)

#model0_step <- readRDS("../../Modelle/Artenzahl_100_step.rds")

#model4c <- MASS::glm.nb(Artenanzahl_det ~ I(imp^2), data = A1_1000) #

# test <- sjPlot::tab_model(model0_step, model2a_step, model3a_step,model4c,model5c,
#                   dv.labels = c("imp100", "imp250", "imp500", "imp1000", "imp2000"),
#                   file = "model_Artenzahl.html", transform = NULL)
## transform html via excel to .csv-file
library(readr)
model_Artenzahl <- read_delim("../model_Artenzahl.csv", 
    ";", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE) 
names(model_Artenzahl) <- model_Artenzahl[2,]
model_Artenzahl[is.na(model_Artenzahl)] <- ""


```



```{r echo=FALSE}

# function for detection of significant values:
p_sig <- function(x){
  x <- unlist(x, recursive = T)
  bold = suppressWarnings((as.numeric(x)<0.05 | x == "<0.001")  & 
                            x != "" &
                            !is.na(x))
  return(bold)
}

kableExtra::kbl(model_Artenzahl[-c(1,2),], booktabs =T, caption = "Modellzusammenfassung der ausgewählten modelle der Artenzahl. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung der Antwortvariablen gefittet.  \\label{summary_Artenzahl} " ) %>% 
  kable_styling(latex_options =c("striped", "hold_position")) %>% 
  kableExtra::add_header_above(
    c(" ", "imp100"=3,"imp250"=3,"imp500"=3,"imp1000"=3, "imp2000" = 3)
  ) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down")) %>% 
  # kableExtra::column_spec(c(4,7,10, 13,16),
  #                         bold = p_sig(.)) %>% 
  kableExtra::column_spec(4,bold = p_sig(model_Artenzahl[-c(1,2),4])) %>% 
  kableExtra::column_spec(7,bold = p_sig(model_Artenzahl[-c(1,2),7])) %>% 
  kableExtra::column_spec(10,bold = p_sig(model_Artenzahl[-c(1,2),10])) %>% 
  kableExtra::column_spec(13,bold = p_sig(model_Artenzahl[-c(1,2),13])) %>% 
  kableExtra::column_spec(16,bold = p_sig(model_Artenzahl[-c(1,2),16])) %>% 
  kableExtra::row_spec(6, hline_after = T)

# summary(model0_step)
# summary(model2a_step)
# summary(model3a_step)
# summary(model4c)
# summary(model5c)

```


```{r echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Modelle zur Artenanzahl \\label{plot_modelle_artenzahl}"}
unscale <- function(z, center = attr(z, "scaled:center"), scale = attr(z, "scaled:scale")) {
  if(!is.null(scale))  z <- sweep(z, 2, scale, `*`)
  if(!is.null(center)) z <- sweep(z, 2, center, `+`)
  structure(z,
    "scaled:center"   = NULL,
    "scaled:scale"    = NULL,
    "unscaled:center" = center,
    "unscaled:scale"  = scale
  )
}
# model0_step, model2a_step, model3a_step,model4c,model5c,

model2a_step <- readRDS("../Modelle/Artenzahl_250_step.rds")

newdata <- A1_250 %>% tidyr::expand(imp, mean_annual_temp_celsius) %>% 
  left_join(A1_250[,c("annual_precipitation_mm", "mean_annual_temp_celsius")])
pred_250 <- predict(model2a_step, newdata = newdata, type = "response", se.fit = T) 

pred_250 <- data.frame(pred = pred_250$fit, pred.se = pred_250$se.fit, 
                   imp = newdata$imp) %>% 
  group_by(imp) %>% 
  summarise(mean = mean(pred),
            min = min(pred),
            max = max(pred),
            quant95 = quantile(pred, 0.95),
            quant05 = quantile(pred, 0.05)) 

pred_250 <- pred_250 %>% 
  mutate(imp = unscale(pred_250[,"imp"], center = attr(A1_250$imp, "scaled:center"), scale = attr(A1_250$imp, "scaled:scale"))$imp)

#   ylab("Abundanz der Wirtsbienen") 

model4c <- readRDS("../Modelle/Artenzahl_1000_step.rds")

#
newdata <- A1_1000 %>% tidyr::expand(imp, mean_annual_temp_celsius) %>% 
  left_join(A1_1000[,c("annual_precipitation_mm", "mean_annual_temp_celsius")])
pred_1000 <- predict(model4c, newdata = newdata, type = "response", se.fit = T) 

pred_1000 <- data.frame(pred = pred_1000$fit, pred.se = pred_1000$se.fit, 
                   imp = newdata$imp) %>% 
  group_by(imp) %>% 
  summarise(mean = mean(pred),
            min = mean(pred) - min(pred.se),
            max = mean(pred) + max(pred.se),
            quant95 = quantile(pred, 0.95),
            quant05 = quantile(pred, 0.05))
pred_1000 <- pred_1000 %>% 
  mutate(imp = unscale(pred_1000[,"imp"], center = attr(A1_1000$imp, "scaled:center"), scale = attr(A1_1000$imp, "scaled:scale"))$imp)


#

p1 <- ggplot(data = pred_250, aes(imp, mean)) +
  geom_line() +
  geom_ribbon(aes(ymin = quant05, ymax  =quant95), alpha = 0.2, fill = "blue") +
  geom_line(data = pred_250, aes(imp, mean), col = "darkblue") +
  geom_point(data = A1_250, aes(unscale(imp), Artenanzahl_det), alpha = 0.5)  +
  theme_bw() +
  ylab("Artenanzahl") +
  xlab("mittlerer Versiegelungsgrad [%] im 250m-Radius")


p2 <- ggplot(data = pred_1000, aes(imp, mean)) +
  geom_line() +
  geom_ribbon(aes(ymin = min, ymax  =max), alpha = 0.2, fill = "blue") +
  geom_line(data = pred_1000, aes(imp, mean), col = "darkblue") +
  geom_point(data = A1_1000, aes(unscale(imp), Artenanzahl_det), alpha = 0.5) +
  theme_bw()+
  ylab("Artenanzahl") +
  xlab("mittlerer Versiegelungsgrad [%] im 1000m-Radius")

gridExtra::grid.arrange(p1, p2, ncol = 2, heights = unit(4, c("in")))

```


Um den Einfluss des Versiegelungsgrades verschiedener Radien auf die Abundanz (Anzahl Brutzellen pro Nisthilfe) zu bewerten wurden folgende Modelle unter der Annahme negativbinomialverteilter Daten sowie unter Einbezug des Einflusses der Nullen (Zeroinflation) ausgewählt:

\begin{align}
Abundanz \sim imp_{100}  \label{Ab_1} \\
Abundanz \sim imp_{250}  + Ackerland + Wald \label{Ab_2} \\
Abundanz \sim imp_{250} \label{Ab_2b} \\
 Abundanz \sim imp_{500} + imp_{500}^2 \label{Ab_3} \\
 Abundanz \sim imp_{1000} + imp_{1000}^2 \label{Ab_4} \\
Abundanz \sim imp_{2000} + imp_{2000}^2 \label{Ab_5}
\end{align}

In den Modellformeln bezeichnet "imp_r" den Versiegelungsgrad im Radius r, "Arable" den Flächenanteil an Ackerland im 500m-Radius sowie "Forest" den Flächenanteil an Wald im 500m-Radius. Für die Modellierung der Abundanz anhand des Versiegelungsgrades der Radien 100m und 250m wird dieser als linearer Term im Modlel implementiert. Das Modell mit dem Versiegelungsgrad im 250m-Radius kann durch die Erweiterung um die Prädiktoren des Flächenanteils von Ackerland sowie von Wald verbessert werden.
Für alle Radien des Versiegelungsgrades von 500m und größer wurde das Modell mit dem Versiegelungsgrad als linearen sowie quadratischen Term ausgewählt.  Die Modellzusammenfassung aller Modelle sind in den Tabellen \ref{summary_Abundanz_a} und \ref{summary_Abundanz_b} dargestellt. 

Der Versiegelungsgrad hat im  250m und 500m-Radius einen negativen signifikanten linearen Einfluss auf die Artenzahl der Bienen (siehe Abbildung \ref{plot_modelle_abundanz} links). Mit zunehmender Versiegelung nimmt die Artenzahl ab. Der Anteil des Ackerfläche sowie der Anteil an Wald haben im Modell mit dem Versiegelungsgrad im 250m-Radius einen negativen signifikanten Einfluss auf die Abundanz. 
Für die Radien von 500m, 1000m und 2000m hat der mittlere Versiegelungsgrad jeweils einen signifikanten quadratischen Einfluss auf die Abundanz der Wildbienen, wovon der signifikanzwert von $p=0.001$ im Modell des 2000m-Radius die höchste signifikanz aufweist. Bei einem Versiegelungsgrad von ca. $25 %$ ist die Abundanz maximal (Abbildung \ref{plot_modelle_abundanz} rechts). 



```{r Abundanz, echo=FALSE, message=FALSE, warning=FALSE}

model1b_zi <- readRDS("../Modelle/model1b_zi.rds")
model2a_step_zi <- readRDS("../Modelle/model2a_step_zi.rds")
model2d_zi <- readRDS("../Modelle/model2d_zi.rds")
model3b_zi <- readRDS("../Modelle/model3b_zi.rds")
model4b_zi <- readRDS("../Modelle/model4b_zi.rds")
model5b_zi <- readRDS("../Modelle/model5b_zi.rds")

model_abundanz <- read.csv("../model_abundanz.csv") %>% 
  dplyr::select(-component.250b, -statistic.250b, -statistic.500)

model_abundanz_a <- model_abundanz[-6,-c(11:19)] %>% 
  arrange(component) %>% 
  relocate(component, .after = term) %>% 
   mutate(across(where(is.numeric), round, 3)) %>% 
  mutate_at(vars(contains('value')), 
            funs(case_when(. < 0.001~ "<0.001",
                           . >= 0.001 ~ as.character(.))
            )) %>% 
  replace(is.na(.), "")
names(model_abundanz_a) <- c("term" ,"component", "estimate", "std.error", "p.value", "estimate", "std.error", "p.value", "estimate", "std.error", "p.value" )

model_abundanz_b <- model_abundanz[-c(4,5),-c(2:10)] %>% 
  arrange(component)%>% 
  relocate(component, .after = term) %>% 
   mutate(across(where(is.numeric), round, 3)) %>% 
  mutate_at(vars(contains('value')), 
            funs(case_when(. < 0.001~ "<0.001",
                           . >= 0.001 ~ as.character(.))
            )) %>% 
  replace(is.na(.), "")
names(model_abundanz_b) <- c("term" ,"component", "estimate", "std.error", "p.value", "estimate", "std.error", "p.value", "estimate", "std.error", "p.value" )

kableExtra::kbl(model_abundanz_a, booktabs =T, caption = "Modellzusammenfassung der ausgewählten modelle der Abundanz. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung der Antwortvariablen gefittet.  \\label{summary_Abundanz_a} " ) %>% 
  #kable_styling(latex_options =c("striped", "hold_position")) %>% 
  kableExtra::add_header_above(
    c(" " = 2, "imp100"=3,"imp250"=3,"imp250"=3)
  ) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down", "striped", "hold_position")) %>% 
  # kableExtra::column_spec(c(4,7,10, 13,16),
  #                         bold = p_sig(.)) %>% 
  kableExtra::column_spec(5,bold = p_sig(model_abundanz_a[,5])) %>% 
  kableExtra::column_spec(8,bold = p_sig(model_abundanz_a[,8])) %>% 
  kableExtra::column_spec(11,bold = p_sig(model_abundanz_a[,11])) %>% 
  kableExtra::row_spec(4, hline_after = T)



```



```{r echo=FALSE, message=FALSE, warning=FALSE}
kableExtra::kbl(model_abundanz_b, booktabs =T, caption = "Modellzusammenfassung der ausgewählten modelle der Abundanz. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung der Antwortvariablen gefittet.  \\label{summary_Abundanz_b} " ) %>% 
  kableExtra::add_header_above(
    c(" " = 2, "imp500"=3,"imp1000"=3,"imp2000"=3)
  ) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down", "striped", "hold_position")) %>% 
  # kableExtra::column_spec(c(4,7,10, 13,16),
  #                         bold = p_sig(.)) %>% 
  kableExtra::column_spec(5,bold = p_sig(model_abundanz_b[,5])) %>% 
  kableExtra::column_spec(8,bold = p_sig(model_abundanz_b[,8])) %>% 
  kableExtra::column_spec(11,bold = p_sig(model_abundanz_b[,11])) %>% 
  kableExtra::row_spec(3, hline_after = T)

```



```{r echo=FALSE, message=FALSE, warning=FALSE, fig.show='hold', out.width=c('45%', '45%'), fig.cap="Die Modelle des mittleren Versiegelungsgrades im 250m-Radius (links) sowie 2000m-Radius (rechts), welche den Einfluss der Nullen (Zeroinflation) brücksichtigen. Die Linie beschreibt den Mittelwert der simulierten Daten, der violett gezeichnete Bereich beschreibt Bereich bis zum 95 \\% Quantil der Simulierten Daten, die Punkte sind die realen Messwerte. \\label{plot_modelle_abundanz}"}

#


## prediction erzeugt merkwürdige werte...?
A1_100_sub <- A1_100 %>% 
  filter(Abundanz < 500)
pred_100 <- simulate(model1b_zi, nsim = 1000) # newdata = A1_100, type = "link", se.fit = T 
pred_100 <- data.frame(pred_mean = rowMeans(pred_100),
                       pred_max = matrixStats::rowQuantiles(as.matrix(pred_100), probs = 0.95),
                       pred_min = matrixStats::rowQuantiles(as.matrix(pred_100), probs = 0.05),
                       imp = unscale(A1_100_sub$imp))

A1_250_sub <- A1_250 %>% 
  filter(Abundanz < 500)
pred_250 <- simulate(model2a_step_zi, nsim = 10000) # newdata = A1_100, type = "link", se.fit = T 
pred_250 <- data.frame(pred_mean = rowMeans(pred_250),
                       pred_max = matrixStats::rowQuantiles(as.matrix(pred_250), probs = 0.95),
                       pred_min = matrixStats::rowQuantiles(as.matrix(pred_250), probs = 0.05),
                       imp = unscale(A1_250_sub$imp))



pred_250b <- simulate(model2d_zi, nsim = 10000) # newdata = A1_100, type = "link", se.fit = T 
pred_250b <- data.frame(pred_mean = rowMeans(pred_250b),
                       pred_max = matrixStats::rowQuantiles(as.matrix(pred_250b), probs = 0.95),
                       pred_min = matrixStats::rowQuantiles(as.matrix(pred_250b), probs = 0.05),
                       imp = unscale(A1_250_sub$imp))

ggplot(data = pred_250b, aes(imp, pred_mean)) +
  geom_line() +
  geom_ribbon(aes(ymin = pred_min, ymax  =pred_max), alpha = 0.2, fill = "blue") +
  geom_point(data = A1_250_sub, aes(unscale(imp), Abundanz), alpha = 0.5) +
  theme_bw()+
  xlab("mittlerer Versiegelungsgrad [%] im 250m-Radius") +
  ylab("Abundanz (Anzahl der Brutzellen)")


A1_500_sub <- A1_500 %>% 
  filter(Abundanz < 500)

pred_500 <- simulate(model3b_zi, nsim = 10000) # newdata = A1_100, type = "link", se.fit = T 
pred_500 <- data.frame(pred_mean = rowMeans(pred_500),
                       pred_max = matrixStats::rowQuantiles(as.matrix(pred_500), probs = 0.95),
                       pred_min = matrixStats::rowQuantiles(as.matrix(pred_500), probs = 0.05),
                       imp = unscale(A1_500_sub$imp))


#

A1_1000_sub <- A1_1000 %>% 
  filter(Abundanz < 500)

pred_1000 <- simulate(model4b_zi, nsim = 10000) # newdata = A1_100, type = "link", se.fit = T 
pred_1000 <- data.frame(pred_mean = rowMeans(pred_1000),
                       pred_max = matrixStats::rowQuantiles(as.matrix(pred_1000), probs = 0.95),
                       pred_min = matrixStats::rowQuantiles(as.matrix(pred_1000), probs = 0.05),
                       imp = unscale(A1_1000_sub$imp))

#
A1_2000_sub <- A1_2000 %>% 
  filter(Abundanz < 500)

pred_2000 <- simulate(model5b_zi, nsim = 10000) # newdata = A1_100, type = "link", se.fit = T 
pred_2000 <- data.frame(pred_mean = rowMeans(pred_2000),
                       pred_max = matrixStats::rowQuantiles(as.matrix(pred_2000), probs = 0.95),
                       pred_min = matrixStats::rowQuantiles(as.matrix(pred_2000), probs = 0.05),
                       imp = unscale(A1_2000_sub$imp))


ggplot(data = pred_2000, aes(imp, pred_mean)) +
  geom_line() +
  geom_ribbon(aes(ymin = pred_min, ymax  =pred_max), alpha = 0.2, fill = "blue") +
  geom_point(data = A1_2000_sub, aes(unscale(imp), Abundanz), alpha = 0.5) +
  theme_bw() +
  xlab("mittlerer Versiegelungsgrad [%] im 2000m-Radius") +
  ylab("Abundanz (anzahl Brutzellen)")

```



## Artenzahl der natürlichen Gegenspieler
Das Vorhandensein eines Insektenhauses im Umfeld des Nisthilfenstandortes hat einen positiven signifikanten Einfluss auf die Artenzahl der natürlichen Gegenspieler. Die Modellzusammenfassung des Modells mit dem Parameter zum Insektenhaus sowie mit der Erweiterung um die Parameter des Versiegelungsgrades im 250m-Radius ist in Tabelle \ref{summaryIH_par} dargestellt. Der Effektplot von zweiterem ist in Abbildung \ref{effektplotIH_par} abgebildet.
Das Modell mit der Information über vorhandene Insektenhäuser als unabhängiger Variable kann durch die Erweiterung um die Variablen des mittleren Versiegelungsgrades im 100m-Radius als linearer sowie quadratischer Term verbessert werden. Gleiches gilt für den mittleren Versiegelungsgrad im 250m- und 500m-Radius. Andersherum verbessert der Term des vorhandenen Insektenhauses die Modelle mit dem mittleren Versiegelungsgrad aller Radien.

```{r}
model_par <- rlist::list.clean(XML::readHTMLTable("../model_par_IH.html"), fun = is.null, recursive = FALSE)[[1]]
parnames <-  model_par[1,]
model_par[6:7,5] <- model_par[6:7,3] 
model_par[6:7,3] <- NA
model_par[is.na(model_par)] <- ""
#names(model_par) <- model_par[1,]
model_par1 <- model_par %>% 
  filter(V1 != "Predictors")
names(model_par1) <- parnames

kableExtra::kbl(model_par1,booktabs =T, caption = "Modellzusammenfassung der Modelle der Artenzahl der Parasitoide. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung der Antwortvariablen an den reduzierten Datensatz aller Nisthilfen mit Information zum vorhandensein eines Insektenhauses gefittet.  \\label{summaryIH_par} " ) %>% #caption = "" 
  kableExtra::add_header_above(c(" ","Model 1"=3,"Model 2"=3)) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down", "striped", "hold_position")) %>% 
  kableExtra::column_spec(4,bold = (as.numeric(model_par1[,4])<0.05 | model_par1[,4] == "<0.001")  & model_par1[,4] != "" )%>% 
  kableExtra::column_spec(7,bold = (as.numeric(model_par1[,7])<0.05 | model_par1[,7] == "<0.001") & model_par1[,7] != "")
```



```{r echo=FALSE, fig.show='hold', message=FALSE, warning=FALSE, fig.cap= "Einfluss von vorhandenem Insektenhaus auf Artenanzahl der Parasitoide. Die Fehlerbalken sind 'marginal effect-plots', welche die Vorhersage der Modelle (Mittelwert und Standartabweichung) bei mittlerem Versiegelungsgrad darstellen. Die Punkte sind die realen Datenpunkte. \\label{effektplotIH_par}" }
library(MASS)

sub_IH_scl <- A2 %>% 
  rename(Insektenhaus = Isnsektenhaus) %>% 
  filter(!is.na(Insektenhaus)) %>% 
  dplyr::mutate(Insektenhaus = as.factor(Insektenhaus)) %>% 
  mutate_at(vars(imp100:Forest), scale) %>% 
  mutate_at(vars(test1:test3), scale)
  
sub_IH <- sub_IH_scl %>% 
  mutate_at(vars(imp100:Forest), as.numeric) %>% 
  mutate_at(vars(test1:test3), as.numeric)

## einfluss von Insektenhaus auf artenzahl:
model_IH2_250 <- MASS::glm.nb(Parasitoid ~ imp250 + I(imp250^2) + Insektenhaus, data = sub_IH)


# jtools::effect_plot(model_IH2_250, pred = Insektenhaus, interval = TRUE, plot.points = TRUE,
#                     jitter = .2) + 
#   ylab("Artenzahl der Wirtsbienen")
tranlabels <- c(3.908e+01 + 2.072e+01*-1 , 3.908e+01 + 2.072e+01*0 , 3.908e+01 + 2.072e+01*1 )
tranlabels <- function(x) attr(sub_IH_scl$imp250, "scaled:center") + attr(sub_IH_scl$imp250, "scaled:scale")*x
werte <- paste(round(tranlabels(c(-1, 0, 1)),2), collapse = ", ")

labeltext <- list("Die Werte des skalierten", 
                         "Versiegelunsgrades -1, 0, 1", 
                  "entsprechen den prozentualen", 
                         paste0("Werten von ", werte))

sjPlot::plot_model(model_IH2_250, type = "pred", 
                   terms = c("Insektenhaus", "imp250"), 
                   show.p = T, show.data = T, jitter = T)+
  theme_bw() +
  annotate("text", y = seq(10,8,length=4), x = 0.35,
            label = labeltext)


```


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(readr)
model_Artenzahl_par <- read_delim("../model_Artenzahl_par.csv", 
    ";", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE) 
names(model_Artenzahl_par) <- model_Artenzahl_par[2,]
model_Artenzahl_par[is.na(model_Artenzahl_par)] <- ""


```

Der Einfluss des Versiegelungsgrades auf die Abundanz zeigt in den Modellen des gesamten Datensatz ohne die Information zu vorhandenen Insektenhäusern für die Radien von 100m, 250m und 500m jeweils einen signifikanten linearen Einfluss auf die Artenzahl der natürlichen Gegenspieler. Für die Radien 500m, 1000m und 2000m ist auch ein signifikanter quadratischer Zusammenhang zu erkennen.
Modelle mit dem mittleren Versiegelungsgrad von 250m sowie 500m  können durch die Erweiterung um die Prädiktoren des Flächenanteils von Wald, Weideflächen sowie Ackerland und den Jahresniederschlag verbessert werden. Dabei zeigt sich auch ein signifikanter negativer linearer Zusammenhang zwischen der Abundanz der natürlichen Gegenspielern und den Flächenanteilen von Wald, Weideflächen sowie Ackerland. Das Erweiterte Modell mit dem Versiegelungsgrad im 250m-Radius ist in Abbildung \ref{} dargestellt. Der $R^2$-Wert dieser komplexeren Modelle liegt bei etwa $0.1$ und ist somit höher als der $R^2$-Wert der simpleren Modelle, welche jeweils kleiner als $0.05$ sind.

```{r echo=FALSE, message=FALSE, warning=FALSE}

# function for detection of significant values:
p_sig <- function(x){
  x <- unlist(x, recursive = T)
  bold = suppressWarnings((as.numeric(x)<0.05 | x == "<0.001")  & 
                            x != "" &
                            !is.na(x))
  return(bold)
}

kableExtra::kbl(model_Artenzahl_par[-c(1,2),1:10], booktabs =T, caption = "Modellzusammenfassung der ausgewählten Modelle der Artenzahl der Gegenspieler. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung gefittet.  \\label{summary_Artenzahl_par1} " ) %>% 
  kableExtra::add_header_above(
    c(" ", "imp100"=3,"imp250"=3,"imp250"=3) 
  ) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down", "striped", "hold_position")) %>% 
  # kableExtra::column_spec(c(4,7,10, 13,16),
  #                         bold = p_sig(.)) %>% 
  kableExtra::column_spec(4,bold = p_sig(model_Artenzahl_par[-c(1,2),4])) %>% 
  kableExtra::column_spec(7,bold = p_sig(model_Artenzahl_par[-c(1,2),7])) %>% 
  kableExtra::column_spec(10,bold = p_sig(model_Artenzahl_par[-c(1,2),10])) %>% 
  kableExtra::row_spec(7, hline_after = T)
```



```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

kableExtra::kbl(model_Artenzahl_par[-c(1,2),c(1, 11:22)], booktabs =T, caption = "Modellzusammenfassung der ausgewählten Modelle der Artenzahl der Gegenspieler. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung gefittet.  \\label{summary_Artenzahl_par2} " ) %>% 
  kableExtra::add_header_above(
    c(" ", "imp500"=3,"imp500"=3,"imp1000"=3, "imp2000" = 3) 
  ) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down", "striped", "hold_position")) %>% 
  kableExtra::column_spec(4,bold = p_sig(model_Artenzahl_par[-c(1,2),13])) %>% 
  kableExtra::column_spec(7,bold = p_sig(model_Artenzahl_par[-c(1,2),16])) %>% 
  kableExtra::column_spec(10,bold = p_sig(model_Artenzahl_par[-c(1,2),19])) %>% 
  kableExtra::column_spec(13,bold = p_sig(model_Artenzahl_par[-c(1,2),22])) %>% 
  kableExtra::row_spec(7, hline_after = T)

```



```{r echo=FALSE, message=FALSE, warning=FALSE, out.width=c('45%', '45%'), fig.show= 'hold', fig.cap="Die Modelle des Einflusses von mittlerem Versiegelungsgrades im 250m-Radius (links) sowie 2000m-Radius (rechts) auf die Artenzahl der natürlichen Gegenspieler. Die Linie beschreibt den Mittelwert der simulierten Daten, der violett gezeichnete Bereich beschreibt Bereich bis zum 95 \\% Quantil der Simulierten Daten, die Punkte sind die realen Messwerte \\label{plot_modelle_gegenspieler}", results='asis'}

library(dplyr)
model_par_2a_step <- readRDS("../Modelle/model_par_2a_step.rds")


A2_250 <- A2 %>% 
  dplyr::select(-imp100, -imp500, -imp1000, -imp2000) %>% 
  #select(- Parasitoid, - Abundanz) %>% 
  dplyr::select(-DistInsektenhaus, -Isnsektenhaus) %>% 
  rename(imp = imp250) %>% 
  mutate_at(vars(imp:Forest), scale) %>% 
  dplyr::select(-Urban)


pred_250b <- simulate(model_par_2a_step, nsim = 100000) # newdata = A1_100, type = "link", se.fit = T 
pred_250b <- data.frame(pred_mean = rowMeans(pred_250b),
                       pred_max = matrixStats::rowQuantiles(as.matrix(pred_250b), probs = 0.95),
                       pred_min = matrixStats::rowQuantiles(as.matrix(pred_250b), probs = 0.05),
                       imp = unscale(A2_250$imp))

ggplot(data = pred_250b, aes(imp, pred_mean)) +
  geom_line() +
  geom_ribbon(aes(ymin = pred_min, ymax  =pred_max), alpha = 0.2, fill = "blue") +
  geom_point(data = A2_250, aes(unscale(imp), Parasitoid), alpha = 0.5) +
  theme_bw()+
  xlab("mittlerer Versiegelungsgrad [%] im 250m-Radius") +
  ylab("Artenzahl der Gegenspieler")

## imp2000:
A2_2000 <- A2 %>% 
  dplyr::select(-imp100, -imp250, -imp500, -imp1000) %>% 
  #select(- Parasitoid, - Abundanz) %>% 
  dplyr::select(-DistInsektenhaus, -Isnsektenhaus) %>% 
  rename(imp = imp2000) %>% 
  mutate_at(vars(imp:Forest), scale)%>% 
  dplyr::select(-Urban)

model_par_5c <- readRDS("../Modelle/model_par_5c.rds")

pred_2000 <- simulate(model_par_5c, nsim = 10000) # newdata = A1_100, type = "link", se.fit = T 
pred_2000 <- data.frame(pred_mean = rowMeans(pred_2000),
                       pred_max = matrixStats::rowQuantiles(as.matrix(pred_2000), probs = 0.95),
                       pred_min = matrixStats::rowQuantiles(as.matrix(pred_2000), probs = 0.05),
                       imp = unscale(A2_2000$imp))

ggplot(data = pred_2000, aes(imp, pred_mean)) +
  geom_line() +
  geom_ribbon(aes(ymin = pred_min, ymax  =pred_max), alpha = 0.2, fill = "blue") +
  geom_point(data = A2_2000, aes(unscale(imp), Parasitoid), alpha = 0.5) +
  theme_bw()+
  xlab("mittlerer Versiegelungsgrad [%] im 2000m-Radius") +
  ylab("Artenzahl der Gegenspieler")
```

## Die Abundanz von Osmia bicornis
Die Rostrote Mauerbiene (*Osmia bicornis*) kam in 148 der 259 Nisthilfen vor.

Die Abundanz von Osmia bicornis wurde durch die Anzahl angelegter Nester pro Trapnest berechnet. Es wurde nicht die Anzahl an Brutzellen verwendet, da sich diese schlechter an eine Verteilung fitten lies als die Anzahl angelegter Nester. Da beide Maße stark korrelieren, ist davon auszugehen, dass der Effekt der verschiedenen Prädiktoren auf die Anzahl angelegter Nester sich auch in der Anzahl der Brutzellen zeigt.

Das vorhandensein eines Insektenhauses hat keinen signifikanten Einfluss auf die Abundanz von Osmia bicornis (siehe Tabelle \ref{summary_Abundanz_IH_ob}). Der mittlere Versiegelungrad im 250m Radius um den Nisthilfenstandort verbessert das Modell welches den Einfluss des Insektenhauses auf die Abundanz von *O. bicornis* beschreibt. Der mittlere Versiegelungsgrad anderer Radien verbessert das Modell nicht. Der Parameter Insektenhaus kann keines der Modelle mit den Prädiktoren des Versiegelungsgrades der verschiedenen Radien verbessern. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
model_IH_ob <- read_delim("../Modelle/model_IH_Ob.csv", 
    ";", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE) 
names(model_IH_ob) <- model_IH_ob[2,]
model_IH_ob[is.na(model_IH_ob)] <- ""

kableExtra::kbl(model_IH_ob[-c(1,2),], booktabs =T, caption = "Modellzusammenfassung der ausgewählten Modelle des Einflusses von vorhandenen Insektenhäusern auf die Abundanz von Osmia bicornis. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung gefittet.  \\label{summary_Abundanz_IH_ob} " ) %>% 
  kableExtra::add_header_above(
    c(" ", "model 1"=3,"model 2"=3) 
  ) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down", "striped", "hold_position")) %>% 
  # kableExtra::column_spec(c(4,7,10, 13,16),
  #                         bold = p_sig(.)) %>% 
  kableExtra::column_spec(4,bold = p_sig(model_IH_ob[-c(1,2),4])) %>% 
  kableExtra::column_spec(7,bold = p_sig(model_IH_ob[-c(1,2),7])) %>% 
  kableExtra::row_spec(5, hline_after = T)
```

Als Ergebnis der Modellselektion wurden für den Versiegelungsgrad jedes Radius zwei Modelle ausgewählt mit jeweils ähnlicher Qualität. Für alle Radien bis auf den 500m-Radius ist dabei das erste Modell durch die Formel $Abundanz \sim imp_r^2 + lat$ beschrieben, wobei "lat" für den Breitengrad (latitude) steht, welcher im Modell mit dem Versiegelungsgrad im 500m-Radius (Formel: $Abundanz \sim imp_r^2$ ) nicht vorkommt (siehe Tab. \ref{summary_Abundanz_ob}). Der Versiegelungsgrad im 100m-Radius, sowie im 250m-Radius hat keinen signifikanten Effekt auf die Abundanz von *Osmia bicornis*. Die Modelle des Versiegelungsgrades im 500m, 1000m und 2000m-Radius beschreiben dagegen einen signifikanten quadratischen Einfluss auf die Abundanz von *Osmia bicornis*.  
Das zweite Modell für den jeweiligen Versiegelungsgrad jedes Radius, von dem die zusammenfassende Statistik in Tabelle \ref{} dargestellt ist,  beinhaltet für alle Radien den Prädiktor der Höhenlage des Nisthilfenstandortes. Die Höhenlage hat bis auf im Modell mit dem Versiegelungsgrad von 250m in jedem Modell einen negativen signifikanten Einfluss auf die Abundanz von Osmia bicornis. Die Modelle mit dem Versiegelungsgrad im 500m, 1000m und 2000m-Radius beschreiben jeweils einen signifikante linearen Einfluss als auch einen signifikanten quadratischen Einfluss des Versiegelungsgrades.

```{r echo=FALSE, message=FALSE, warning=FALSE, results = 'asis'}
Ob_models_list <- readRDS(file = "../Modelle/Ob_models_list_new.rds")

test <- sjPlot::tab_model(Ob_models_list[[1]], Ob_models_list[[3]], Ob_models_list[[5]],
                  Ob_models_list[[7]], Ob_models_list[[9]],  
                  dv.labels = c("imp100", "imp250", "imp500", "imp1000", "imp2000"),
                  file = "Modelle/model_Ob1.html", transform = NULL) 

test <- sjPlot::tab_model(Ob_models_list[[2]], Ob_models_list[[4]], Ob_models_list[[6]], 
                  Ob_models_list[[8]], Ob_models_list[[10]],  
                  dv.labels = c("imp100", "imp250", "imp500", "imp1000", "imp2000"),
                  file = "Modelle/model_Ob2.html", transform = NULL) 


library(readr)
model_ob1 <- read_delim("../Modelle/model_Ob1.csv", 
    ";", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE) 

names(model_ob1) <- model_ob1[2,]
model_ob1[is.na(model_ob1)] <- ""

model_ob2 <- read_delim("../Modelle/model_Ob2.csv", 
    ";", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE) 
names(model_ob2) <- model_ob2[2,]
model_ob2[is.na(model_ob2)] <- ""

# list(teil1 = model_ob1[,1:8], teil2 = model_ob1[,9:16]) %>% 
# #split(1:ncol(model_ob1), sort(rep_len(1:2, ncol(model_ob1)))) %>%
#   
#   #purrr::map(~dplyr::select(model_ob1, .)) %>%
#   purrr::map(kable, booktabs = T) %>%
#   purrr::map(kable_styling) %>%
#   purrr::walk(print)

kableExtra::kbl(model_ob1[-c(1,2),], booktabs =T, caption = "Modellzusammenfassung der ausgewählten Modelle der Abundanz von Osmia bicornis. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung gefittet.  \\label{summary_Abundanz_ob} " ) %>% 
  kableExtra::add_header_above(
    c(" ", "imp100"=3,"imp250"=3,"imp500"=3, "imp1000"=3, "imp2000"=3) 
  ) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down", "striped", "hold_position")) %>% 
  # kableExtra::column_spec(c(4,7,10, 13,16),
  #                         bold = p_sig(.)) %>% 
  kableExtra::column_spec(4,bold = p_sig(model_ob1[-c(1,2),4])) %>% 
  kableExtra::column_spec(7,bold = p_sig(model_ob1[-c(1,2),7])) %>% 
  kableExtra::column_spec(10,bold = p_sig(model_ob1[-c(1,2),10])) %>% 
  kableExtra::column_spec(13,bold = p_sig(model_ob1[-c(1,2),13])) %>% 
  kableExtra::column_spec(16,bold = p_sig(model_ob1[-c(1,2),16])) %>% 
  kableExtra::row_spec(3, hline_after = T)

kableExtra::kbl(model_ob2[-c(1,2),], booktabs =T, caption = "Modellzusammenfassung der ausgewählten Modelle der Abundanz von Osmia bicornis. Die Modelle wurden jeweils unter der Annahme der Negativbinomialverteilung gefittet.  \\label{summary_Abundanz_ob2} " ) %>% 
  kableExtra::add_header_above(
    c(" ", "imp100"=3,"imp250"=3,"imp500"=3, "imp1000"=3, "imp2000"=3) 
  ) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down", "striped", "hold_position")) %>% 
  # kableExtra::column_spec(c(4,7,10, 13,16),
  #                         bold = p_sig(.)) %>% 
  kableExtra::column_spec(4,bold = p_sig(model_ob2[-c(1,2),4])) %>% 
  kableExtra::column_spec(7,bold = p_sig(model_ob2[-c(1,2),7])) %>% 
  kableExtra::column_spec(10,bold = p_sig(model_ob2[-c(1,2),10])) %>% 
  kableExtra::column_spec(13,bold = p_sig(model_ob2[-c(1,2),13])) %>% 
  kableExtra::column_spec(16,bold = p_sig(model_ob2[-c(1,2),16])) %>% 
  kableExtra::row_spec(8, hline_after = T)

```


## Artengemeinschaft
Die Analyse der Artengemeinschaft entlang des Stadt-Land-Gradienten zeigte, dass weder Strukturparameter noch Versiegelungsgrad verschiedener Radien einen Einfluss auf die Zusammensetzung der Arten in den Trapnestern hat.

Die Artengemeinschaft von Standorten, bei denen im 500m-Radius Ackerland vorkommt unterscheidet sich nicht von der Artengemeinschaft, bei der im 500m-Radius kein Ackerland vorkomt.
<!-- -envfit Versiegelungsgrad und Strukturreichtum -->
<!-- - Adonis zwei Gruppen 50 versiegeltste STandorte und 50 unversiegelste Standorte (ländlich) -->


(ref:lonelytab) Auflistung der Arten, welche nur in einer Nisthilfe vorkommen, mit der Information wiviele Nester in der Nisthilfe belegt waren ('Nests') und dem mittleren Versiegelungsgrad in % im 500m-Radius der besiedelten Nisthilfe. \label{lonely_species} 


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Arten die nur in einem Nest vorkamen:
lonely_species <- read.csv("../summaryTabellen/lonely_species_summary.csv")

lonely_species %>%
  kable(booktabs = T, linesep = "",  caption = "(ref:lonelytab)") %>%
  kable_paper(full_width = F) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header",  "hold_position")) %>% 
  column_spec(3, color = "white",
              background =spec_color(lonely_species$imp500, end = 0.50))



```


Es kamen elf Arten in nur einer Nisthilfe vor. Die Arten sind in Tabelle \ref{lonely_species} inklusive dem Versiegelungsgrad im 500m-Radius der Nisthilfe aufgeführt. Neun der elf Arten kamen in relativ gering versiegeltem Umfeld vor (Versiegelungsgrad im 500m-Radius < 25%). 
In Tabelle \ref{multiple_species} sind alle Arten aufgeführt, die in mehr als einer Nisthilfe vorkamen, sowie die Info in welcher Kategorie des Versiegelungsgrades die Nisthilfe vorkam.



(ref:landspec) Auflistung der Arten, welche in mehr als einer Nisthilfe vorkamen. Die Nisthilfen wurden Anhand der 33% und 66%-Quantile des Versiegelungsgrades im 500m-Radius in die Kategorien 'Land' (<33%), 'Übergang' (>33% und <66%) und 'Stadt'(>66%)  unterteilt. In der Tabelle ist die Anzahl an besidelten Nisthilfen der jeweiligen Kategorie dargestellt. Der Anteil an besiedelten Nisthilfen in der Stadt ('Anteil_Stadt') beschreibt den Anteil von besiedelten Nisthilfen in der Stadt an der Summe von besiedelten Nisthilfen von Stadt und Land. Der Übergangsbereich wird nicht miteinberechnet. \label{multiple_species}


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Arten nd wo sie vorkamen:
land_species <- read.csv("../summaryTabellen/Arten_Stad_Land.csv")
land_species <- land_species %>% arrange(Anteil_stadt)


rows <- seq_len(nrow(land_species) %/% 2)

# list(land_species[rows,],  
#            matrix(numeric(), nrow=0, ncol=1),
#            land_species[-rows, ])


land_species %>% 
  kable(booktabs = T, linesep = "", longtable =T, caption = "(ref:landspec)") %>% #
  kable_paper(full_width = F) %>%
  kableExtra::kable_styling(latex_options =c("repeat_header", "scale_down")) %>% 
  column_spec(5, color = "white",
              background =spec_color(land_species$Anteil_stadt, end = 1))

```


<!-- ## Thema -->

<!-- Detecting landscape patterns that impact the wild bee diversity and promote the potential occurance of different wild bee species. Landscape patterns like landuse type, imperviousness and water bodies may act as proxi-variables for the available nesting- and food-resources that directly affect the occurance of different wild bee species. -->

<!--  In the changing environment, wild bees adapt to new habitats. The knowledge about wild bees species hotspots, especially in urban areas, is important to design appropriate measures to promote diversity.  -->

## Netzwerkanalyse
Die Netzwerkanalyse der Kategorie "Land", welche 107 Nisthilfenstandorte beinhaltet und der Kategorie "Stadt" welche 110 Nisthilfenstandorte beinhaltest, ergibt für beide Kategorieen mit dem Index H2 einen mittleren Spezialisierungsgrad von 0.60 bzw. 0.61. Alle Werte der Generalisierung der natürlichen Gegenspieler als auch der Vulnerabilität der Wirtsbienenarten beider Gruppen liegen zwischen $2.0$ und $2.5$. Somit sind keine deutlichen Unterschiede der Wirt-Parasit-Beziehungen zwischen ländlichen Nisthilfenstandorten und urbanen Nisthilfenstandorten zu erkennen. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

Praedi_groups <- Praedis %>% 
  #filter(Praedis$ID %in% Artenzahl$location) %>% 
  mutate(
    group = ifelse(
      imp500 > quantile(Praedis$imp500, probs = 0.66),
      "stadt",
      ifelse(
        imp500 <= quantile(Praedis$imp500, probs = 0.33),
        "land",
        "medium"
      )
    )
  ) %>% 
  mutate(group = as.factor(group)) %>% 
  mutate(Ackerland = as.factor(case_when(Arable > 0  ~ "arable",
                                         Arable == 0 ~ "non_arable")))

library(bipartite) 

#table(Praedi_groups[,c("group")])
nw <- Artenzahl %>% 
  dplyr::select(id, location, species_type, Art) %>% 
  group_by(species_type, id) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(names_from = species_type, values_from = Art) %>%
  dplyr::select(-row) %>% 
  left_join(dplyr::select(Praedi_groups, ID, group, Ackerland), by = c("location"= "ID")) %>% 
  filter(!is.na(Parasitoid)) %>% 
  filter(!is.na(Host))
  
nw_frame <-  frame2webs(nw, varnames = c("Host", "Parasitoid", "group"))

plotweb(nw_frame[[1]])
plotweb(nw_frame[[3]])

visweb(nw_frame[[1]])
visweb(nw_frame[[3]])

# round(networklevel(nw_frame[[1]], index = c("generality", "H2", "links per species", "nestedness", "connectance" )),2)
# round(networklevel(nw_frame[[3]], index = c("generality", "H2", "links per species", "nestedness", "connectance" )),2)
```


<!-- invasive arten? -->

